---
title: "An√°lisis descriptivo"
format: html
author: Danna Catalina Amezquita Borja
execute: 
  warning: false
---

# Introducci√≥n

El an√°lisis de redes permite representar interacciones complejas entre entidades ‚Äîya sean personas, lugares o instituciones‚Äî a trav√©s de nodos y aristas. En este trabajo se emplean herramientas de R para construir, caracterizar y visualizar una red real.

El objetivo es identificar estructuras internas como comunidades, medir homofilia por atributos y analizar la robustez del sistema ante la eliminaci√≥n de nodos clave.

# Metodolog√≠a

La red se modela como un grafo no dirigido $G = (V, E)$ donde los v√©rtices representan las unidades de an√°lisis y las aristas indican relaciones de proximidad, interacci√≥n o similitud. A continuaci√≥n se describen los pasos anal√≠ticos seguidos.

## Construcci√≥n del grafo de proximidad

Los datos provienen de *Google Places* y contienen informaci√≥n sobre fundaciones de gatos ubicadas en Bogot√° y sus alrededores. Cada fila representa un nodo con atributos espec√≠ficos *(coordenadas geogr√°ficas, calificaci√≥n, n√∫mero de rese√±as)*. La red se construye usando el modelo de vecinos m√°s cercanos $(k-NN)$ y la distancia haversine:

```{r, echo=FALSE}
library(igraph)
library(dplyr)
library(knitr)
library(DT)
library(tidyr)
library(ggplot2)
library(plotly)
library(leaflet)
library(geosphere)
library(FNN)
library(readr)
library(tibble)
library(ggraph)
```

```{r}
options(repr.plot.width = 10, repr.plot.height = 8)

df <- read_csv("fundacion_gato.csv")

coords <- as.matrix(df[c("lat", "lon")])
coords_rad <- coords * pi / 180

k <- 6
```

El grafo resultante muestra una conectividad espacial significativa entre las fundaciones de gatos en Bogot√°. Con $k=6$ vecinos m√°s cercanos, cada fundaci√≥n se conecta geogr√°ficamente con $6$ fundaciones cercanas, creando una red moderadamente densa de $60$ nodos.

# An√°lisis estructural de la red

## Construcci√≥n del grafo de proximidad

La red analizada se construy√≥ a partir de un conjunto de datos recopilado mediante la plataforma *Google Places*, exportado en formato `fundacion_gato.csv`. Cada registro corresponde a una fundaci√≥n de gatos e incluye su nombre, coordenadas geogr√°ficas *(latitud y longitud)*, calificaci√≥n promedio *(rating)* y n√∫mero de rese√±as reportadas por los usuarios, dando un total de $60$ fundaciones distribuidas en Bogot√° y sus alrededores.

A partir de esta informaci√≥n se defini√≥ un grafo no dirigido $G = (V, E)$ en el que cada nodo representa una fundaci√≥n y cada arista une a seis fundaciones espacialmente pr√≥ximas. La relaci√≥n de vecindad se determin√≥ mediante el modelo de $k$ vecinos m√°s cercanos $(k-NN)$, empleando la distancia haversine (en radianes) como m√©trica de proximidad geogr√°fica. El par√°metro $k = 6$ controla la densidad del grafo: valores mayores generan m√°s enlaces y, por tanto, una red m√°s densa y conectada.

Para construir la red, las coordenadas geogr√°ficas de cada fundaci√≥n se transforman a radianes con el fin de calcular correctamente las distancias mediante la f√≥rmula de Haversine. A partir de estas distancias, se determina cu√°les son las seis fundaciones m√°s cercanas a cada una y se establecen conexiones bidireccionales entre ellas. Finalmente, a cada conexi√≥n se le asigna como peso la distancia en kil√≥metros que separa a las fundaciones, lo que permite representar no solo la relaci√≥n de vecindad, sino tambi√©n la intensidad de esa cercan√≠a geogr√°fica.

```{r}
knn_result <- get.knn(coords_rad, k = k)

edges <- list()
weights <- c()

R <- 6371 

for (i in 1:nrow(df)) {
  for (j_pos in 1:k) {
    j <- knn_result$nn.index[i, j_pos]

    if (i != j) {
      d_km <- distHaversine(coords[i, ], coords[j, ]) / 1000

      edges <- append(edges, list(c(i, j)))
      weights <- c(weights, d_km)
    }
  }
}

edges_mat <- do.call(rbind, edges)
edges_sorted <- t(apply(edges_mat, 1, sort))   
edges_unique <- unique(edges_sorted)

G_gato <- graph_from_edgelist(edges_unique, directed = FALSE)

V(G_gato)$name <- df$nombre
V(G_gato)$rating <- df$rating
V(G_gato)$lat <- df$lat
V(G_gato)$lon <- df$lon

x_norm <- (df$lon - min(df$lon)) / (max(df$lon) - min(df$lon))
y_norm <- (df$lat - min(df$lat)) / (max(df$lat) - min(df$lat))
coords_2d <- cbind(x_norm, y_norm)

plot(
  G_gato,
  layout = coords_2d,
  vertex.size = 6,
  vertex.color = "tomato",
  vertex.label = NA,
  edge.arrow.mode = 0,
  edge.color = "gray70",
  edge.width = 0.7,
  main = "Red de fundaciones de gatos en Bogot√° (k vecinos m√°s cercanos)",
  sub = paste("Grafo k-NN sim√©trico (k =", k, ")")
)

```

En el grafo las conexiones no reflejan afinidad organizacional o colaboraci√≥n directa, sino cercan√≠a geogr√°fica dentro del tejido urbano bogotano. De este modo, la red modela la estructura espacial de la oferta de cuidado felino en la ciudad y permite explorar su conectividad y posibles conglomerados geogr√°ficos.

La distribuci√≥n espacial de las fundaciones evidencia una mayor presencia en el norte y centro de Bogot√°, lo que genera una red con una componente principal s√≥lida y algunas extensiones perif√©ricas. El uso de $k=6$ permite mantener un nivel de conexi√≥n equilibrado, suficiente para conservar la cohesi√≥n del grafo sin introducir enlaces innecesarios.

Con esta configuraci√≥n es posible observar c√≥mo se organiza territorialmente la oferta de cuidado felino en la ciudad y analizar variaciones que podr√≠an estar asociadas a factores como las caracter√≠sticas socioecon√≥micas, la disponibilidad de espacio o la densidad poblacional de cada zona.

## Grado y distribuci√≥n del grafo

El grado $k_i$ de un nodo $i$ representa el n√∫mero de vecinos directos con los que est√° conectado, en este caso ser√≠a el n√∫mero de otras fundaciones que est√°n geogr√°ficamente cercanas:

$$k_i = \sum_{j} A_{ij}$$

donde $A$ es la matriz de adyacencia del grafo.

```{r}
densidad <- edge_density(G_gato)
n_nodos <- vcount(G_gato)
n_aristas <- ecount(G_gato)

cat("Nodos:", n_nodos, "| Aristas:", n_aristas,
    "| Densidad:", sprintf("%.4f", densidad), "\n")

grados <- degree(G_gato)
cat("Grado medio:", sprintf("%.2f", mean(grados)),
    "| Mediana:", median(grados),
    "| M√°ximo:", max(grados), "\n")
```

El promedio y la dispersi√≥n de estos valores resumen el nivel de conectividad local. En la red analizada se observ√≥ un grado medio de $8.27$, lo que indica que cada fundaci√≥n est√° conectada con alrededor de ocho vecinas. Aunque el modelo parte de $k=6$, las conexiones bidireccionales elevan ligeramente este valor, reflejando una red suficientemente densa para permitir comunicaci√≥n y apoyo entre organizaciones. La mediana, igual a $8$, confirma que la distribuci√≥n de conexiones es bastante equilibrada, sin fundaciones extremadamente aisladas o sobresaturadas.

El grado m√°ximo, de $13$ conexiones, corresponde a una fundaci√≥n que act√∫a como nodo central dentro de la red. Su posici√≥n geogr√°fica al norte de Bogot√° le permite desempe√±ar un papel relevante en la coordinaci√≥n y el flujo de informaci√≥n entre las dem√°s fundaciones y con el p√∫blico objetivo.

## Componentes conexos

```{r}
componentes <- components(G_gato)
cat("Componentes:", componentes$no, 
    "tama√±os:", componentes$csize, "\n")
```

Para evaluar la conectividad global se identificaron las componentes conexas del grafo, es decir, los subconjuntos de nodos que se encuentran enlazados entre s√≠ por al menos un camino. El resultado mostr√≥ la presencia de una √∫nica componente gigante que abarca todas las fundaciones a pesar de que algunas est√°n bastante alejadas de la zona urbana.

La existencia de una √∫nica componente principal dominante indica una cobertura territorial equilibrada (apesar de los puntos m√°s alejados de Bogot√°) permitiendo as√≠ la posibilidad de coordinaci√≥n entre entidades, facilidad de transporte, compartir recursos, entre otros.

## Centralidades: grado, cercan√≠a y betweeness

```{r}
c_deg <- centr_degree(G_gato, normalized = TRUE)$res
c_clo <- closeness(G_gato, normalized = TRUE)
c_bet <- betweenness(G_gato, normalized = TRUE)

tabla_centralidades <- data.frame(
  nombre = V(G_gato)$name,
  degree = round(c_deg, 4),
  closeness = round(c_clo, 4),
  betweenness = round(c_bet, 4)
)

top_idx <- order(c_bet, decreasing = TRUE)[1:5]
top_bet <- data.frame(
  nombre = V(G_gato)$name[top_idx],
  betweenness = round(c_bet[top_idx], 4)
)

datatable(
  tabla_centralidades,
  options = list(pageLength = 10),
  caption = "Tabla din√°mica de centralidades del grafo"
)
```

La estructura de la red se analiz√≥ tambi√©n a partir de tres medidas de centralidad complementarias:

-   Centralidad de grado, que cuantifica la popularidad local de cada nodo *(fundaci√≥n)*.

-   Centralidad de cercan√≠a *(closeness)*, que mide la accesibilidad promedio al resto de la red.

-   Centralidad de intermediaci√≥n *(betweenness)*, que identifica nodos puente ubicados en las rutas m√°s cortas entre pares de v√©rtices.

Las fundaciones con alto grado se concentran en zonas densas y urbanas, mientras que aquellos con elevada *betweenness* act√∫an como conectores entre la ciudad y los nodos m√°s alejados. Estos nodos puente resultan estrat√©gicos para la difusi√≥n de informaci√≥n o para el dise√±o de rutas urbanas, dado que su eliminaci√≥n podr√≠a fragmentar la red o aumentar las distancias promedio.

## Coeficiente de agrupamiento

El coeficiente de clustering describe la densidad local de tri√°ngulos y se define como

$$C_i = \frac{2t_i}{k_i(k_i - 1)},$$

donde $t_i$ es el n√∫mero de tri√°ngulos que incluyen al nodo $i$. El valor medio

$$C = \frac{1}{|V|}\sum_i C_i$$

resume el nivel general de agrupamiento de la red.

```{r}
clustering_prom <- transitivity(G_gato, type = "average")
cat("Clustering promedio:", sprintf("%.4f", clustering_prom), "\n")
```

En la red de fundaciones, el clustering promedio result√≥ moderadamente alto *(de 0.634)*, lo que refleja una distribuci√≥n concentrada en ciertas zonas de Bogot√°, en especial en el norte, lo que facilita la comunicaci√≥n entre cada una de las entidades para resoluci√≥n de emergencias o compartir recursos de ser necesario.

## Caminos m√°s cortos

Para la componente gigante se estimaron la longitud promedio de los caminos m√≠nimos *(ASP, Average Shortest Path)* y el di√°metro de la red.

```{r}
componentes <- components(G_gato)
id_gcc <- which.max(componentes$csize)

Gcc <- induced_subgraph(
  G_gato,
  vids = V(G_gato)[componentes$membership == id_gcc]
)

asp <- mean_distance(Gcc, weights = E(Gcc)$weight, directed = FALSE)

diam <- diameter(Gcc, weights = E(Gcc)$weight, directed = FALSE)

cat(
  sprintf(
    "Longitud promedio de camino (ASP): %.4f | Di√°metro: %.4f\n",
    asp, diam
  )
)
```

La eficiencia de la red *(ASP = 3.41)* muestra que cualquier fundaci√≥n puede conectarse con otra en pocos pasos, lo que facilita la comunicaci√≥n, la coordinaci√≥n y la respuesta r√°pida ante casos urgentes o necesidades de reubicaci√≥n. Adem√°s, el di√°metro de $8$ indica que la red mantiene su conectividad incluso en las zonas m√°s perif√©ricas, reflejando una distribuci√≥n territorial equilibrada de los servicios de cuidado felino en Bogot√°.

## Comunidades y modularidad

Para identificar agrupamientos estructurales se aplic√≥ el algoritmo de maximizaci√≥n de modularidad *(greedy modularity)*. La m√©trica de modularidad $Q$ cuantifica la densidad interna de las comunidades frente a las conexiones externas:

$$Q = \frac{1}{2m}\sum_{i,j}\left[A_{ij} - \frac{k_i k_j}{2m}\right]\delta(c_i, c_j),$$

donde $m$ es el n√∫mero total de aristas y $Œ¥(ci, cj) = 1$ si los nodos $i$ y $j$ pertenecen a la misma comunidad.

```{r}
coms <- cluster_louvain(G_gato, weights = E(G_gato)$weight)

num_coms <- length(coms)

Q <- modularity(coms)

cat(
  sprintf(
    "Comunidades: %d | Modularidad Q: %.4f\n",
    num_coms, Q
  )
)
```

Se detectaron cinco comunidades principales con un valor de $Q = 0.576$, indicador de una estructura comunitaria bien definida.

```{r}
V(G_gato)$comunidad <- membership(coms)

plot(
  G_gato,
  layout = coords_2d,
  vertex.size = 7,
  vertex.label = NA,
  vertex.color = V(G_gato)$comunidad,
  edge.color = "gray",
  main = "Comunidades detectadas (Louvain)"
)
```

Cada grupo corresponde a una zona geogr√°fica diferente como la zona norte dentro de Bogot√°, o distintas zonas en los aldededores.

## Distribuci√≥n de grados

Finalmente, la distribuci√≥n de grados es unimodal con una ligera cola a la derecha, con un grado modal de $8$ conexiones y un rango que va de $6$ a $13$ por fundaci√≥n. La mayor√≠a de organizaciones *(37 de 60)* se concentran entre $6$ y $8$ conexiones, mientras que los grados m√°s altos disminuyen progresivamente, con solo una fundaci√≥n alcanzando el m√°ximo. Este patr√≥n refleja una red equilibrada, sin nodos aislados ni dominancia excesiva, lo que contribuye a su estabilidad estructural. Adem√°s, garantiza buena accesibilidad entre fundaciones y permite una expansi√≥n futura sin comprometer la cohesi√≥n ni generar puntos cr√≠ticos de falla.

```{r}
hist(grados, 
     breaks = seq(min(grados), max(grados) + 1, 1) - 0.5,
     main = "Distribuci√≥n de grado ‚Äî Red de fundaciones en Bogot√°",
     xlab = "Grado (vecinos)",
     ylab = "Frecuencia de fundaciones de gatos",
     col = "lightblue",
     border = "darkblue")

```

# Rutas, subgrafos y sensibilidad estructural de la red

Esta secci√≥n complementa el an√°lisis estructural mediante el estudio de rutas √≥ptimas, subgrafos inducidos por atributos y evaluaci√≥n de robustez ante la remoci√≥n de nodos clave. Se busca entender no s√≥lo c√≥mo se organiza la red, sino tambi√©n qu√© tan eficiente y resistente es frente a perturbaciones locales.

## Datos generales

La red final est√° compuesta por $|V| = 60$ nodos y $|E| = 248$ aristas, construidas a partir de la relaci√≥n de proximidad geogr√°fica definida por el modelo de $k-vecinos$ m√°s cercanos con $k = 6$.

Cada nodo representa una fundaci√≥n en Bogot√° y sus alrededores,y conserva atributos como su nombre y calificaci√≥n promedio *(rating)*. A modo de ejemplo:

1.  Fundacion El Gatio ‚Äî Rating 4.7

2.  CASA MIL BIGOTES ‚Äî Rating 4.7

3.  El Orfagato ‚Äî Rating 4.5

La red presenta una estructura conectada y densa, adecuada para el an√°lisis de rutas y medidas de accesibilidad.

## Ruta √≥ptima inicial (Dijkstra)

Para ilustrar la eficiencia de las conexiones, se calcul√≥ la ruta m√°s corta ‚Äîen t√©rminos de distancia geogr√°fica‚Äî entre dos nodos estrat√©gicos de la red principal.

```{r}
library(igraph)

ruta_mas_corta <- function(G_gato, posicion1, posicion2) {
  
  if (posicion1 >= vcount(G_gato) || posicion2 >= vcount(G_gato)) {
    cat("‚ñ≤ Alguno de los √≠ndices no existe en el grafo.\n")
    return(G_gato)
  }
  
  src <- V(G_gato)[posicion1 + 1]
  tgt <- V(G_gato)[posicion2 + 1]
  
  ruta <- shortest_paths(
    G_gato,
    from = src,
    to = tgt,
    weights = E(G_gato)$weight,
    output = "vpath"
  )$vpath[[1]]
  
  distancia <- distances(
    G_gato,
    v = src,
    to = tgt,
    weights = E(G_gato)$weight
  )
  
  # Marcar nodos
  V(G_gato)$en_ruta <- FALSE
  V(G_gato)$en_ruta[ruta] <- TRUE
  
  # Marcar aristas
  E(G_gato)$en_ruta <- FALSE
  E(G_gato, path = ruta)$en_ruta <- TRUE
  
  cat(
    sprintf(
      "Ruta m√°s corta entre %s y %s:\n",
      V(G_gato)$nombre[src],
      V(G_gato)$nombre[tgt]
    )
  )
  
  cat(paste(V(G_gato)$nombre[ruta], collapse = " -> "), "\n")
  
  cat(
    sprintf(
      "Distancia (radianes): %.5f (~ %.2f km)\n",
      distancia,
      distancia * 6371
    )
  )
  
  return(G_gato)
}
```

El camino √≥ptimo identificado usando la funci√≥n anterior fue:

FIMLM ‚Üí Fundacion Doggy In Home ‚Üí Fundaci√≥n Hogar De Paso Perro Amor

La distancia total estimada fue de 2 radianes, equivalente aproximadamente a 12.742 kil√≥metros.

El recorrido se desarrolla entre la localidad de Suba y el municipio de Cota, conectando solo 3 fundaciones. El nodo Fundacion Doggy In Home funciona como puente intermedio que enlaza la parte rural de Bogot√° con Cota. En t√©rminos estructurales, estos nodos acortan rutas globales y contribuyen a la eficiencia espacial del sistema.

## Subgrafo inducido por atributo

Con el fin de explorar la homogeneidad por calidad percibida, se gener√≥ un subgrafo compuesto √∫nicamente por las fundaciones con calificaci√≥n promedio *rating ‚â• 4.5*.

```{r}
indices_rating_alto <- which(V(G_gato)$rating >= 4.5)
G_sub <- induced_subgraph(G_gato, indices_rating_alto)

cat("Subgrafo de fundaciones con rating ‚â• 4.5:\n")
cat("Nodos:", vcount(G_sub), ", Aristas:", ecount(G_sub), "\n")

plot(
  G_sub, 
  layout = coords_2d[indices_rating_alto, ],
  vertex.size = 8,
  vertex.color = "green",
  vertex.frame.color = "white",
  vertex.frame.width = 1,
  vertex.label = NA,        
  edge.color = "gray",
  edge.width = 0.5,
  main = "Subgrafo con rating ‚â• 4.5",
  xlab = "", ylab = "",
  xaxt = "n", yaxt = "n",
  bty = "n"
)
```

El subgrafo resultante conserv√≥ $29$ nodos y $61$ aristas, representando menos del $50%$ de la estructura original *(48.3% de nodos y 24.6% de aristas)*.

Esta estructura bifurcada del subgrafo indica que existe una divisi√≥n significativa en la distribuci√≥n de fundaciones de gatos con rating alto *(‚â• 4.5)* dentro del territorio de Bogot√°. La diferencia de tama√±o entre los grupos sugiere que las fundaciones de alta calidad no est√°n uniformemente distribuidas, sino que se concentran en la zona noroccidente y a las afuerzas de bogot√° por el sur, dejando una parte grande de la ciudad sin cubrir. Resaltando tambi√©n la alta concentraci√≥n de fundaciones hacia el norte

## An√°lisis de sensibilidad: Impacto de remover nodos clave

Para evaluar la resiliencia estructural de la red, se analizaron los efectos de eliminar nodos previamente identificados con alta centralidad de intermediaci√≥n *(betweenness)*.

Se midieron dos indicadores antes y despu√©s de cada eliminaci√≥n:

-   N√∫mero de componentes conexos *(C)*.

-   Longitud promedio de caminos m√≠nimos *(ASP, Average Shortest Path)*.

```{r}
impacto_remocion <- function(G_gato, posicion) {
  
  if (posicion >= vcount(G_gato)) {
    cat("‚ö†Ô∏è La posici√≥n no existe en el grafo.\n")
    return(invisible(NULL))
  }
  
  nodo <- V(G_gato)[posicion + 1]
  nombre_gato <- V(G_gato)$nombre[nodo]
  
  comps_antes <- components(G_gato)
  num_antes <- comps_antes$no
  
  gcc_id <- which.max(comps_antes$csize)
  Gcc <- induced_subgraph(G_gato, comps_antes$membership == gcc_id)
  
  asp_antes <- average.path.length(
    Gcc,
    weights = E(Gcc)$weight,
    directed = FALSE
  )
  
  G2 <- delete_vertices(G_gato, nodo)
  
  comps_despues <- components(G2)
  num_despues <- comps_despues$no
  
  gcc2_id <- which.max(comps_despues$csize)
  Gcc2 <- induced_subgraph(G2, comps_despues$membership == gcc2_id)
  
  asp_despues <- average.path.length(
    Gcc2,
    weights = E(Gcc2)$weight,
    directed = FALSE
  )
  
  cat("\nüîπ Fundaci√≥n removida:", nombre_gato, "(Posici√≥n:", posicion, ")\n")
  cat("Componentes:", num_antes, "‚Üí", num_despues, "\n")
  cat(
    sprintf(
      "ASP (camino promedio): %.3f ‚Üí %.3f\n",
      asp_antes, asp_despues
    )
  )
  cat(
    sprintf(
      "Œî Componentes = %d, Œî ASP = %.3f\n",
      num_despues - num_antes,
      asp_despues - asp_antes
    )
  )
}

```

| Fundaci√≥n removida | Comp. | ASP | $\Delta C$ | $\Delta ASP$ | Interpretaci√≥n |
|------------|------------|------------|------------|------------|------------|
| Coraz√≥n Peludito Foundation | 1‚Üí1 | 3.410‚Üí3.680 | 0 | +0.270 | Redundante: no rompe la red, pero aumenta ligeramente las distancias m√≠nimas. |
| GatoLatte Cat Cafe | 1‚Üí1 | 3.410‚Üí3.448 | 0 | +0.039 | Redundante: no rompe la red, pero aumenta ligeramente las distancias m√≠nimas. |
| GATOS GATOS Y PERROS | 1‚Üí1 | 3.410‚Üí3.508 | 0 | +0.099 | Redundante: no rompe la red, pero aumenta ligeramente las distancias m√≠nimas. |

El resultado no muestra un contraste claro entre nodos cr√≠ticos y redundantes. Puntualmente para Corazon Peludito Foundation, su ausencia no fragmenta la red en t√©rminos de n√∫mero de componentes *(mantiene C = 1)*, pero aumenta sustancialmente la distancia promedio de caminos m√≠nimos (ASP) de 3.410 a 3.68 pasos. Esto indica que, aunque la red permanece conectada, la eliminaci√≥n de esta fundaci√≥n crea rutas significativamente m√°s largas, afectando la eficiencia de coordinaci√≥n y respuesta entre fundaciones.
