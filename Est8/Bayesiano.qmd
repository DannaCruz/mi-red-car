---
title: "Bayesiano"
author: "Samuel A. Moreno"
format: html
editor: visual
---

## Preparaci√≥n del entorno y datos espaciales

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE
)

library(readr)
library(dplyr)
library(sf)
library(spdep)
library(CARBayes)
library(ggplot2)

```

Se carg√≥ el shapefile de las localidades de Bogot√° y se construy√≥ la matriz de adyacencia ùëä espacial basada en contig√ºidad. Esta matriz define la estructura de vecindad del modelo CAR y representa la dependencia territorial entre localidades vecinas.

## Datos de estaciones de gasolina e IIV

```{r}
df <- read_csv("resultados_movilidad_trafico.csv")

df <- df %>%
  filter(!is.na(lat), !is.na(lon), !is.na(IIV))

n <- nrow(df)

```

Cada observaci√≥n corresponde a una estaci√≥n de gasolina georreferenciada, caracterizada por su √çndice de Impacto Vehicular (IIV), el cual resume su rol estructural dentro de la red espacial y su relaci√≥n con la infraestructura vial.

## Construcci√≥n de la matriz de adyacencia ùëä

```{r}
coords <- as.matrix(df[, c("lon", "lat")])

k <- 6  # n√∫mero de vecinos m√°s cercanos

knn <- knearneigh(coords, k = k)
nb  <- knn2nb(knn)

W <- nb2mat(nb, style = "B")

# Forzar simetr√≠a (requerido por CARBayes)
W <- (W + t(W)) > 0
W <- 1 * W

# Asegurar diagonal cero
diag(W) <- 0


```

La matriz ùëä es una matriz binaria de vecindad espacial construida a partir de la contig√ºidad entre localidades. Su estructura es compatible con los requerimientos del modelo CAR, garantizando una representaci√≥n v√°lida de la dependencia espacial.

## Datos para el modelo CAR

```{r}
car_data <- data.frame(
  IIV = df$IIV
)

```

Las estaciones fueron asignadas a sus respectivas localidades y el IIV fue agregado mediante el promedio por unidad administrativa. Esto permite analizar el impacto vehicular potencial a una escala territorial coherente con la estructura del modelo espacial.

## Modelo CAR bayesiano

```{r}
invisible(
  capture.output(
    modelo <- S.CARleroux(
      formula  = IIV ~ 1,
      family   = "gaussian",
      data     = car_data,
      W        = W,
      burnin   = 100,
      n.sample = 1000,
      thin     = 1
    )
  )
)

```

Se estim√≥ un modelo CAR de Leroux con una especificaci√≥n gaussiana que incluye un intercepto y un t√©rmino espacial estructurado. El objetivo es evaluar la presencia de autocorrelaci√≥n espacial en el IIV promedio entre localidades vecinas.

```{r}
summary(modelo)
```

## Efectos espaciales y visualizaci√≥n

```{r}

theta_hat <- apply(modelo$samples$phi, 2, mean)

df$phi <- theta_hat


```

```{r}

df_sf <- st_as_sf(df, coords = c("lon", "lat"), crs = 4326)

ggplot(df_sf) +
  geom_sf(aes(color = phi), size = 2) +
  scale_color_viridis_c() +
  labs(
    title = "Efectos espaciales del IIV (modelo CAR)",
    color = expression(phi)
  ) +
  theme_minimal()


```

Los efectos espaciales $\phi_i$‚Äã capturan la variaci√≥n territorial del IIV promedio no explicada por el nivel global. Valores positivos indican localidades con mayor impacto vehicular relativo, mientras que valores negativos corresponden a zonas con menor impacto.

El an√°lisis confirma que el √çndice de Impacto Vehicular presenta una estructura espacial a nivel de localidades en Bogot√°..
